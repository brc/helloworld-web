substitutions:
  _REG_HOST: us-docker.pkg.dev
  _PROJ_ID: id-me-build
  _DEV_REPO: docker-dev
  _APP: helloworld

  _IMG: ${_REG_HOST}/${_PROJ_ID}/${_DEV_REPO}/${_APP}
  _TAG: ${_PR_NUMBER}

  _REGION_US01: us-west2
  _REGION_US02: us-east4

options:
     dynamic_substitutions: true


# TODO(brett): Move this tooling to custom build image w/dedicated scripts.

steps:
  ###
  ## Build Docker image
  ##
  - name: "gcr.io/cloud-builders/docker"
    entrypoint: 'bash'
    args:
    - '-c'
    - |-
      set -eEu
      echo "====> Building image"
      docker build . \
          -t "${_IMG}:${_TAG}" \
          -t "${_IMG}:latest" \

      echo "====> Pushing image"
      docker push "${_IMG}:${_TAG}"
      docker push "${_IMG}:latest"

  ###
  ## Deploy image to dev
  ##
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: 'bash'
    args:
    - '-c'
    - |-
      set -eEu
      echo "====> Deploying image"
      gcloud run deploy "${_APP}-dev-pr${_PR_NUMBER}" \
          --image="${_IMG}:${_TAG}" \
          --region="${_REGION_US01}" \
          --ingress=internal-and-cloud-load-balancing
